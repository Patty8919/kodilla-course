DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
	DECLARE BOOKSREAD, DAYS, BKS_ID, RDR_ID INT;
	DECLARE BOOKSPERMONTH DECIMAL(5,2);
	DECLARE BESTSELLERS BOOLEAN;
    DECLARE FINISHED INT DEFAULT 0;
    DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM BOOKS;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
    OPEN ALL_BOOKS;
    WHILE (FINISHED = 0) DO
		FETCH ALL_BOOKS INTO BKS_ID;
        IF (FINISHED = 0) THEN
			SELECT COUNT(*) FROM RENTS
            WHERE BOOK_ID = BKS_ID
            INTO BOOKSREAD;
            SELECT DATEDIFF(MAX(RENT_DATE), MIN(RENT_DATE)) + 1 FROM RENTS
            WHERE BOOK_ID = BKS_ID
            INTO DAYS;
			SET BOOKSPERMONTH = BOOKSREAD / DAYS * 30;
            UPDATE BOOKS SET BESTSELLER = BESTSELLERS(BOOKSPERMONTH)
			WHERE BOOK_ID = BKS_ID;

            COMMIT;
		END IF;
	END WHILE;

	CLOSE ALL_BOOKS;
END $$

DELIMITER ;